<!DOCTYPE html>
<html lang="th">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>‡∏£‡∏±‡∏ö‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£ - ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏î‡∏¥‡∏à‡∏¥‡∏ó‡∏±‡∏•</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.1.6/dist/signature_pad.umd.min.js"></script>
    <script
      charset="utf-8"
      src="https://static.line-scdn.net/liff/edge/2/sdk.js"
    ></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              primary: "#4f46e5",
              secondary: "#06b6d4",
              accent: "#f59e0b",
            },
            fontFamily: {
              thai: ["Sarabun", "system-ui", "sans-serif"],
            },
            animation: {
              "fade-in": "fadeIn 0.5s ease-in-out",
              "slide-up": "slideUp 0.6s ease-out",
              "pulse-slow": "pulse 3s infinite",
            },
          },
        },
      };
    </script>
    <link
      href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <style>
      @keyframes fadeIn {
        from {
          opacity: 0;
        }
        to {
          opacity: 1;
        }
      }
      @keyframes slideUp {
        from {
          opacity: 0;
          transform: translateY(20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .glass-effect {
        background: rgba(255, 255, 255, 0.9);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.2);
      }

      .gradient-bg {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      }

      .card-hover {
        transition: all 0.3s ease;
      }

      .card-hover:hover {
        transform: translateY(-2px);
        box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1),
          0 10px 10px -5px rgba(0, 0, 0, 0.04);
      }

      .checkbox-custom {
        appearance: none;
        -webkit-appearance: none;
        -moz-appearance: none;
        width: 1.25rem;
        height: 1.25rem;
        border: 2px solid #d1d5db;
        border-radius: 0.375rem;
        position: relative;
        cursor: pointer;
        transition: all 0.2s ease;
        background-color: white;
      }

      .checkbox-custom:checked {
        background-color: #4f46e5;
        border-color: #4f46e5;
      }

      .checkbox-custom:checked::before {
        content: "";
        position: absolute;
        top: 50%;
        left: 50%;
        width: 6px;
        height: 10px;
        border: solid white;
        border-width: 0 2px 2px 0;
        transform: translate(-50%, -60%) rotate(45deg);
        display: block;
      }

      .checkbox-custom:indeterminate {
        background-color: #4f46e5;
        border-color: #4f46e5;
      }

      .checkbox-custom:indeterminate::before {
        content: "";
        position: absolute;
        top: 50%;
        left: 50%;
        width: 8px;
        height: 2px;
        background-color: white;
        transform: translate(-50%, -50%);
        display: block;
        border: none;
      }

      .signature-canvas {
        border: 2px dashed #e5e7eb;
        transition: border-color 0.3s ease;
      }

      .signature-canvas:hover {
        border-color: #4f46e5;
      }

      .btn-primary {
        background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
        transition: all 0.3s ease;
      }

      .btn-primary:hover {
        transform: translateY(-1px);
        box-shadow: 0 10px 20px rgba(79, 70, 229, 0.3);
      }

      .status-badge {
        animation: pulse-slow 3s infinite;
      }
    </style>
  </head>
  <body
    class="font-thai bg-gradient-to-br from-blue-50 via-indigo-50 to-purple-50 min-h-screen"
  >
    <!-- Header -->
    <div class="gradient-bg text-white py-6 shadow-lg">
      <div class="container mx-auto px-4">
        <div class="flex items-center justify-center space-x-3">
          <div
            class="w-10 h-10 bg-white bg-opacity-20 rounded-full flex items-center justify-center"
          >
            <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
              <path
                d="M4 4a2 2 0 00-2 2v8a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2H4zm0 2h12v8H4V6z"
              />
              <path d="M6 8h8v2H6V8zm0 4h6v2H6v-2z" />
            </svg>
          </div>
          <div>
            <h1 class="text-sm font-bold">‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡πÇ‡∏î‡∏¢‡∏á‡∏≤‡∏ô‡∏ò‡∏∏‡∏£‡∏Å‡∏≤‡∏£</h1>
            <h1 class="text-sm font-bold">‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ä‡∏∏‡∏°‡∏ä‡∏ô‡∏ß‡∏±‡∏î‡πÑ‡∏ó‡∏¢‡∏á‡∏≤‡∏°</h1>
          </div>

        </div>
      </div>
    </div>

    <div class="container mx-auto px-4 py-8">
      <div class="max-w-4xl mx-auto">
        <!-- Status Card -->
        <div
          class="glass-effect rounded-2xl shadow-xl p-6 mb-8 animate-fade-in"
        >
          <div class="flex items-center justify-center space-x-3 mb-4">
            <div class="status-badge w-3 h-3 bg-green-500 rounded-full"></div>
            <h2 class="text-xl font-semibold text-gray-800">
              ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏£‡∏±‡∏ö‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£
            </h2>
          </div>
        </div>

        <!-- Document List -->
        <div
          class="glass-effect rounded-2xl shadow-xl p-8 mb-8 animate-slide-up"
        >
          <div class="flex items-center space-x-3 mb-6">
            <div
              class="w-8 h-8 bg-gradient-to-r from-blue-500 to-purple-600 rounded-lg flex items-center justify-center"
            >
              <svg
                class="w-5 h-5 text-white"
                fill="currentColor"
                viewBox="0 0 20 20"
              >
                <path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z" />
                <path
                  fill-rule="evenodd"
                  d="M4 5a2 2 0 012-2v1a1 1 0 001 1h6a1 1 0 001-1V3a2 2 0 012 2v6a2 2 0 01-2 2H6a2 2 0 01-2-2V5z"
                  clip-rule="evenodd"
                />
              </svg>
            </div>
            <h3 class="text-2xl font-bold text-gray-800">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£</h3>
          </div>

          <div id="docInfo" class="space-y-4">
            <div class="flex items-center justify-center py-12">
              <div
                class="animate-spin rounded-full h-12 w-12 border-b-2 border-primary"
              ></div>
              <p class="ml-4 text-gray-600 font-medium">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</p>
            </div>
          </div>

          <!-- Select All Option -->
          <div
            id="selectAllContainer"
            class="hidden mt-6 p-4 bg-gray-50 rounded-xl border-2 border-dashed border-gray-300"
          >
            <label class="flex items-center space-x-3 cursor-pointer">
              <input type="checkbox" id="selectAll" class="checkbox-custom" />
              <span class="font-semibold text-gray-700"
                >‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</span
              >
            </label>
          </div>
        </div>

        <!-- Signature Section -->
        <div class="glass-effect rounded-2xl shadow-xl p-8 animate-slide-up">
          
          <div class="mb-6">
  <label class="block mb-3 font-semibold text-gray-700">
    ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏û‡∏∂‡∏á‡∏û‡∏≠‡πÉ‡∏à‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£:
  </label>
  <div class="flex items-center space-x-6 justify-center text-4xl">
    <button onclick="setSatisfaction('excellent')" class="focus:outline-none hover:scale-110 transition-transform" id="smile-excellent">
      üòä
    </button>
    <button onclick="setSatisfaction('average')" class="focus:outline-none hover:scale-110 transition-transform" id="smile-average">
      üòê
    </button>
    <button onclick="setSatisfaction('poor')" class="focus:outline-none hover:scale-110 transition-transform" id="smile-poor">
      üòû
    </button>
  </div>
  <p id="satisfaction-text" class="text-center text-gray-600 mt-3"></p>
</div>

          <div class="flex items-center space-x-3 mb-6">
            <div
              class="w-8 h-8 bg-gradient-to-r from-green-500 to-teal-600 rounded-lg flex items-center justify-center"
            >
              <svg
                class="w-5 h-5 text-white"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"
                />
              </svg>
            </div>
            <h3 class="text-2xl font-bold text-gray-800">‡∏•‡∏á‡∏ô‡∏≤‡∏°‡∏£‡∏±‡∏ö‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£</h3>
          </div>

          <div class="mb-6">
            <label class="block mb-3 font-semibold text-gray-700">
              ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏ã‡πá‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡πÉ‡∏ô‡∏Å‡∏£‡∏≠‡∏ö‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£:
            </label>
            <div class="relative">
              <canvas
                id="signaturePad"
                class="signature-canvas rounded-xl w-full h-64 bg-white cursor-crosshair"
              ></canvas>
              <div
                class="absolute top-4 right-4 text-gray-400 text-sm pointer-events-none"
              >
                ‡∏•‡∏á‡∏ô‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà
              </div>
            </div>
          </div>

          <div class="flex flex-col sm:flex-row gap-4 justify-between">
            <button
              onclick="clearSignature()"
              class="flex items-center justify-center space-x-2 px-6 py-3 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-xl transition-all duration-300 font-medium"
            >
              <svg
                class="w-5 h-5"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"
                />
              </svg>
              <span>‡∏•‡πâ‡∏≤‡∏á‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô</span>
            </button>

            <button
              onclick="saveSignature()"
              class="flex items-center justify-center space-x-2 px-8 py-3 btn-primary text-white rounded-xl font-medium shadow-lg"
            >
              <svg
                class="w-5 h-5"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M5 13l4 4L19 7"
                />
              </svg>
              <span>‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÅ‡∏•‡∏∞‡∏™‡πà‡∏á‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô</span>
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Success Modal -->
    <div
      id="successModal"
      class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50"
    >
      <div
        class="bg-white rounded-2xl p-8 max-w-md mx-4 text-center animate-slide-up"
      >
        <div
          class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4"
        >
          <svg
            class="w-8 h-8 text-green-600"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M5 13l4 4L19 7"
            />
          </svg>
        </div>
        <h3 class="text-xl font-bold text-gray-800 mb-2">‡∏™‡πà‡∏á‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!</h3>
        <p class="text-gray-600 mb-6">
          ‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏î‡πâ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß
        </p>
        <button
          onclick="closeModal()"
          class="btn-primary text-white px-6 py-2 rounded-lg"
        >
          ‡∏ï‡∏Å‡∏•‡∏á
        </button>
      </div>
    </div>

    <script>
      // Initialize LIFF
      let liffInitialized = false;
      let userProfile = null;
      let documentsData = [];

      // Initialize LIFF when page loads
      window.addEventListener("load", async () => {
        try {
          await liff.init({
            liffId: "1657704109-0O9XKKwj",
            withLoginOnExternalBrowser: true,
          });
          if (!liff.isLoggedIn()) {
            liff.login({ redirectUri: window.location.href });

            return;
          }

          // Get user profile
          userProfile = await liff.getProfile();
          console.log("User profile:", userProfile);
        } catch (error) {
          console.error("LIFF initialization failed:", error);
        }
      });

      // ‡∏£‡∏±‡∏ö‡∏Ñ‡πà‡∏≤‡∏à‡∏≤‡∏Å‡∏û‡∏≤‡∏£‡∏≤‡∏°‡∏¥‡πÄ‡∏ï‡∏≠‡∏£‡πå
      const params = new URLSearchParams(window.location.search);
      const submissionId = params.get("doc");
      const docInfoDiv = document.getElementById("docInfo");
      let selectedDocuments = [];

      if (!submissionId) {
        docInfoDiv.innerHTML = `
          <div class="text-center py-12">
            <div class="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4">
              <svg class="w-8 h-8 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"/>
              </svg>
            </div>
            <p class='text-red-600 font-medium'>‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏û‡∏≤‡∏£‡∏≤‡∏°‡∏¥‡πÄ‡∏ï‡∏≠‡∏£‡πå doc</p>
          </div>
        `;
      } else {
        fetch(`https://apithaigham01.vercel.app/api/doc/${submissionId}`)
          .then((res) => res.json())
          .then((data) => {
            if (!data || !data.submission || !data.submission.documents) {
              docInfoDiv.innerHTML = `
                <div class="text-center py-12">
                  <div class="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4">
                    <svg class="w-8 h-8 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                    </svg>
                  </div>
                  <p class='text-gray-600 font-medium'>‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£</p>
                </div>
              `;
              return;
            }

            const docs = data.submission.documents;
            documentsData = docs; // Store for later use

            if (docs.length === 0) {
              docInfoDiv.innerHTML = `
                <div class="text-center py-12">
                  <div class="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4">
                    <svg class="w-8 h-8 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                    </svg>
                  </div>
                  <p class='text-gray-600 font-medium'>‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£</p>
                </div>
              `;
              return;
            }

            // Show select all container
            document
              .getElementById("selectAllContainer")
              .classList.remove("hidden");

            docInfoDiv.innerHTML = docs
              .map(
                (doc, index) => `
                <div class="card-hover bg-white rounded-xl border border-gray-200 p-6 shadow-sm">
                  <div class="flex items-start space-x-4">
                    <div class="flex-shrink-0 pt-1">
<input 
  type="checkbox" 
  id="doc_${index}" 
  class="checkbox-custom" 
  onchange="updateSelectedDocuments(${index}, this.checked)"
>
                    </div>
                    <div class="flex-1">
                      <div class="flex items-center space-x-2 mb-3">
                        <div class="w-6 h-6 bg-blue-100 rounded-lg flex items-center justify-center">
                          <svg class="w-4 h-4 text-blue-600" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M4 4a2 2 0 00-2 2v8a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2H4zm0 2h12v8H4V6z"/>
                          </svg>
                        </div>
                        <h4 class="font-bold text-lg text-gray-800">${
                          doc.docname || "‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏"
                        }</h4>
                      </div>
                      
                      <div class="space-y-3">
                        <div class="flex items-center space-x-2">
                          <svg class="w-4 h-4 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a.997.997 0 01-1.414 0l-7-7A1.997 1.997 0 013 12V7a4 4 0 014-4z"/>
                          </svg>
                          <span class="text-gray-600"><strong>‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á:</strong> ${
                            doc.title || "‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏"
                          }</span>
                        </div>
                        
                        <div class="flex items-center space-x-2">
                          <svg class="w-4 h-4 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3a1 1 0 011-1h6a1 1 0 011 1v4m4 0H4a1 1 0 00-1 1v10a1 1 0 001 1h16a1 1 0 001-1V8a1 1 0 00-1-1z"/>
                          </svg>
                          <span class="text-gray-600"><strong>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ù‡∏≤‡∏Å:</strong> ${new Date(
                            doc.created_at
                          ).toLocaleDateString("th-TH")}</span>
                        </div>
                        
                        ${
                          doc.note
                            ? `
                        <div class="flex items-start space-x-2">
                          <svg class="w-4 h-4 text-gray-500 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                          </svg>
                          <span class="text-gray-600"><strong>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏:</strong> ${doc.note}</span>
                        </div>
                        `
                            : ""
                        }
                      </div>
                      
                      <div class="mt-4 pt-4 border-t border-gray-100">
                        <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800">
                          <svg class="w-3 h-3 mr-1" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                          </svg>
                          ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏£‡∏±‡∏ö
                        </span>
                      </div>
                    </div>
                  </div>
                </div>
              `
              )
              .join("");

            // Setup select all functionality
            const selectAllCheckbox = document.getElementById("selectAll");
            if (selectAllCheckbox) {
              selectAllCheckbox.addEventListener("change", function () {
                const checkboxes = document.querySelectorAll('[id^="doc_"]');
                const isChecked = this.checked;

                // Clear selected documents array
                selectedDocuments = [];

                checkboxes.forEach((checkbox, index) => {
                  checkbox.checked = isChecked;
                  if (isChecked) {
                    selectedDocuments.push(index);
                  }
                });

                console.log("Selected documents:", selectedDocuments);
              });
            }
          })
          .catch((err) => {
            docInfoDiv.innerHTML = `
              <div class="text-center py-12">
                <div class="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4">
                  <svg class="w-8 h-8 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                  </svg>
                </div>
                <p class='text-red-600 font-medium'>‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</p>
              </div>
            `;
            console.error(err);
          });
      }

let satisfactionLevel = "";

function setSatisfaction(level) {
  satisfactionLevel = level;
  const textMap = {
    excellent: "‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°‡∏¢‡∏≠‡∏î‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î",
    average: "‡∏û‡∏≠‡πÉ‡∏ä‡πâ",
    poor: "‡∏Ñ‡∏ß‡∏£‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á"
  };

  document.getElementById("satisfaction-text").innerText =
    `‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏•‡∏∑‡∏≠‡∏Å: ${textMap[level]}`;

  // ‡πÑ‡∏Æ‡πÑ‡∏•‡∏ï‡πå‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
  ["excellent", "average", "poor"].forEach((id) => {
    document.getElementById(`smile-${id}`).classList.remove("opacity-30");
  });
  document.getElementById(`smile-excellent`).classList.add(level !== "excellent" ? "opacity-30" : "");
  document.getElementById(`smile-average`).classList.add(level !== "average" ? "opacity-30" : "");
  document.getElementById(`smile-poor`).classList.add(level !== "poor" ? "opacity-30" : "");
}


      
      function updateSelectedDocuments(index, isSelected) {
        if (isSelected) {
          if (!selectedDocuments.includes(index)) {
            selectedDocuments.push(index);
          }
        } else {
          selectedDocuments = selectedDocuments.filter((i) => i !== index);
        }

        // Update select all checkbox state
        const totalCheckboxes =
          document.querySelectorAll('[id^="doc_"]').length;
        const selectAllCheckbox = document.getElementById("selectAll");
        if (selectAllCheckbox && totalCheckboxes > 0) {
          if (selectedDocuments.length === totalCheckboxes) {
            selectAllCheckbox.checked = true;
            selectAllCheckbox.indeterminate = false;
          } else if (selectedDocuments.length > 0) {
            selectAllCheckbox.checked = false;
            selectAllCheckbox.indeterminate = true;
          } else {
            selectAllCheckbox.checked = false;
            selectAllCheckbox.indeterminate = false;
          }
        }

        console.log("Selected documents:", selectedDocuments);
      }

      // SignaturePad
      const canvas = document.getElementById("signaturePad");

      // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏õ‡∏£‡∏±‡∏ö‡∏Ç‡∏ô‡∏≤‡∏î canvas ‡πÉ‡∏´‡πâ‡∏Ñ‡∏°‡∏ä‡∏±‡∏î
      function resizeCanvas() {
        const ratio = Math.max(window.devicePixelRatio || 1, 1);
        const width = canvas.offsetWidth;
        const height = canvas.offsetHeight;

        canvas.width = width * ratio;
        canvas.height = height * ratio;
        canvas.getContext("2d").scale(ratio, ratio);
        canvas.style.width = width + "px";
        canvas.style.height = height + "px";
      }

      resizeCanvas(); // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å‡∏Å‡πà‡∏≠‡∏ô‡∏™‡∏£‡πâ‡∏≤‡∏á signaturePad

      const signaturePad = new SignaturePad(canvas, {
        backgroundColor: "rgba(255, 255, 255, 0)",
        penColor: "rgb(79, 70, 229)",
      });

      // ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö responsive canvas
      window.addEventListener("resize", () => {
        const data = signaturePad.toData();
        resizeCanvas();
        signaturePad.clear();
        signaturePad.fromData(data);
      });

      function clearSignature() {
        signaturePad.clear();
      }

      async function saveSignature() {
        if (selectedDocuments.length === 0) {
          alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£");
          return;
        }

        if (signaturePad.isEmpty()) {
          alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏ã‡πá‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡πà‡∏≠‡∏ô‡∏™‡πà‡∏á");
          return;
        }

        if (!satisfactionLevel) {
          alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏û‡∏∂‡∏á‡∏û‡∏≠‡πÉ‡∏à‡∏Å‡πà‡∏≠‡∏ô‡∏™‡πà‡∏á");
          return;
        }

        const imageData = signaturePad.toDataURL();
        
        const selectedDocsDetails = selectedDocuments.map(
          (index) => documentsData[index]
        );

       console.log("‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å: ", selectedDocsDetails);
        console.log("‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô: ", imageData);

const flexshowmessage = {
  type: "flex",
  altText: "‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö‡πÅ‡∏•‡πâ‡∏ß",
  contents: {
    type: "bubble",
    size: "mega",
    header: {
      type: "box",
      layout: "vertical",
      contents: [
        {
          type: "text",
          text: "üìÑ ‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö‡πÅ‡∏•‡πâ‡∏ß",
          weight: "bold",
          size: "xl",
          color: "#1DB446",
          align: "center"
        },
        {
          type: "text",
          text: `‡∏à‡∏≥‡∏ô‡∏ß‡∏ô ${selectedDocsDetails.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`,
          size: "sm",
          color: "#888888",
          align: "center",
          margin: "sm"
        }
      ]
    },
    body: {
      type: "box",
      layout: "vertical",
      spacing: "sm",
      contents: selectedDocsDetails.flatMap((doc, index) => [
        {
          type: "box",
          layout: "vertical",
          paddingAll: "12px",
          backgroundColor: "#F9F9F9",
          cornerRadius: "md",
          contents: [
            {
              type: "text",
              text: `#${index + 1} : ${doc.title || "-"}`,
              weight: "bold",
              size: "md",
              wrap: true,
              color: "#333333"
            },
            {
              type: "text",
              text: `üÜî ‡∏£‡∏´‡∏±‡∏™: ${doc.submission_id || "-"}`,
              size: "sm",
              color: "#555555",
              wrap: true,
              margin: "sm"
            },
            {
              type: "text",
              text: `üóì ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: ${new Date(doc.created_at).toLocaleDateString("th-TH")}`,
              size: "sm",
              color: "#555555",
              margin: "sm"
            },
            {
              type: "text",
              text: `üìù ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: ${doc.note || "-"}`,
              size: "sm",
              color: "#777777",
              wrap: true,
              margin: "sm"
            }
          ]
        },
        ...(index < selectedDocsDetails.length - 1
          ? [{ type: "separator", margin: "md" }]
          : [])
      ])
    },
footer: {
  type: "box",
  layout: "vertical",
  contents: [
    {
      type: "text",
      text: `üòä ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏û‡∏∂‡∏á‡∏û‡∏≠‡πÉ‡∏à: ${
        satisfactionLevel === "excellent"
          ? "‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°‡∏¢‡∏≠‡∏î‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î"
          : satisfactionLevel === "average"
          ? "‡∏û‡∏≠‡πÉ‡∏ä‡πâ"
          : "‡∏Ñ‡∏ß‡∏£‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á"
      }`,
      size: "sm",
      color: "#555555",
      align: "center",
      margin: "md",
      wrap: true
    },
    {
      type: "text",
      text: "‚úÖ ‡∏Ç‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£",
      size: "sm",
      color: "#AAAAAA",
      align: "center",
      margin: "md"
    }
  ]
}

  }
};


        try {
            if (liff.isInClient()) {
            // üì± ‡∏£‡∏±‡∏ô‡πÉ‡∏ô‡πÅ‡∏≠‡∏õ LINE ‡∏ö‡∏ô‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠
            await liff.sendMessages([flexshowmessage]);
            console.log("‚úÖ ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ú‡πà‡∏≤‡∏ô sendMessages ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
              liff.closeWindow() 
            } else {
            // üíª ‡∏´‡∏£‡∏∑‡∏≠ browser ‡∏õ‡∏Å‡∏ï‡∏¥ (Desktop, Safari, etc.)
            await liff.shareTargetPicker([flexshowmessage]);
            console.log("‚úÖ ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ú‡πà‡∏≤‡∏ô shareTargetPicker ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
              liff.closeWindow() 
            }
        } catch (err) {
            console.error("‚ùå LINE Flex Message Error:", err);
            alert("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° LINE ‡πÑ‡∏î‡πâ: " + err.message);
        }
      }



      function closeModal() {
        document.getElementById("successModal").classList.add("hidden");
      }
    </script>
  </body>
</html>
